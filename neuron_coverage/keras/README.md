# DNN Coverage

Function to calculate neuron coverage and display it in the form of a heat map

* Supports `Dense`, `Conv2d` layers of Keras

## Requirement

- Python 3.6
- See [neuron_coverage_keras.sh](lib/neuron_coverage_keras.sh)


## Tutorial
* There are 2 ways to use this function: importing as a module and invoking from DeepSaucer.

* When used as a module: [1. Common operation](#1-common-operation) → [2. Direct execution](#2-direct-execution) → [4. Output](#4-output)
* When invoked from DeepSaucer: [1. Common operation](#1-common-operation) → [3. Invoking from DeepSaucer](#3-invoking-from-deepsaucer) → [4. Output](#4-output)

### 1. Common Operation
---
1. **Create the config file**

    Set coverage function setting information in json format

    | Setting Item | Key | Type | Setting Value |
    | ---- | ---- | ----| ---- |
    | Neuron Activity/Inactivity <br>Determination Type | `determination_on_activation` | Number Value | `0`: Threshold Determination<br>`1`: Upper/Lower Limit Determination<br>`2`: N Cases of Maximum Value Determination |
    | Threshold | `threshold` | Number Value | The default value is `0`<br>(Valid only for `threshold determination`) |
    | Lower Limit | `lower_bound` | Number Value | The default value is `0`<br>(Valid and mandatory only for `upper/lower limit determination`) |
    | Upper Limit | `upper_bound` | Number Value | No default value<br>(Valid only for `upper/lower limit determination`) |
    | Number of Cases N | `activation_filter_no` | Number Value | The default value is `1`<br>(Valid and mandatory only for `N cases of maximum value determination`) |
    | Heat Map Generation Method Type | `heat_map_type` | Number Value | `0`: Generation Not Necessary<br>`1`: 0/1 Table<br>`2`: Simple Increment<br>`3`: Density Coverage<br>The default value is `1` |   |   |   |   |   |

    ex ) [lib/config/config.json](lib/config/config.json)

1. **GTSRB Test Data Creation**
   - When using the GTSRB material in the tutorial, perform the following operations.
   1. Download the following 3 items from [German Traffic Sign Benchmarks](http://benchmark.ini.rub.de/?section=gtsrb&subsectio)
      * [German Traffic Signs Training Dataset](http://benchmark.ini.rub.de/Dataset/GTSRB_Final_Training_Images.zip)
      * [German Traffic Signs Test Dataset](http://benchmark.ini.rub.de/Dataset/GTSRB_Final_Test_Images.zip)
      * [German Traffic Signs Test Dataset - Label Data](http://benchmark.ini.rub.de/Dataset/GTSRB_Final_Test_GT.zip)

   1. Decompress the downloaded files, and place them in the following directory structure.
      ```text
      GTSRB_data
      |-- GT-final_test.csv -> Label information corresponding to each image of the test data set
      |-- Final_Test -> Test Data Set
      |   `── Images
      `-- Final_Training -> Training Data Set, images stored for each labeled folder
          `-- Images
              |-- 00000
              |-- 00001
              |-- ...
              |-- 00041
              `-- 00042
      ```

   1. Execute [`generate_gtsrb.py`](examples/gtsrb/generate_gtsrb.py) taking the path of GTSRB_data
      ```shell
      python generate_gtsrb.py -d /Any/Path/GTSRB_data
      ```
      `test_dataset_3_32_32.h5` and `train_dataset_3_32_32.h5` are generated in the same directory as `generate_gtsrb.py`

      How to Use the Generated dataset
      ```python
      from keras.utils import HDF5Matrix

      path = "input_data/test_dataset_3_32_32.h5"

      # images for 'images'
      images = HDF5Matrix(path, "images")[:]

      # labels corresponding to images for 'labels'
      labels = HDF5Matrix(path, "labels")[:]
      print(images.shape)
      # Out[13]: (12630, 3, 32, 32)
      print(labels.shape)
      # Out[14]: (12630, 43)
      ```

### 2. Direct Execution
---
For direct execution, execute by giving 3 parameters to the main function as follows
```python
main(model, dataset, config_path)
```
| Parameters | Type | Description |
| --- | --- | --- |
| model | Model | Model Generated by Keras |
| dataset | ndarray | Data Set used for Test |
| conf_path | Number Value | Config File Path used for Test |

```python
from keras.models import load_model
from lib.preprocess import load_dataset
from lib.coverage_verification import main

model = load_model("/path/to/model_file.h5 or model_file.hdf5")
x, y = load_dataset("/path/to/dataset.h5 or dataset.hdf5")
config_path = '/path/to/config.json'

main(model, x, config_path)
```

Practical Example using MNIST material: [examples/mnist/run_mnist.py](examples/mnist/run_mnist.py)

Practical Example using GTSRB material: [examples/gtsrb/run_gtsrb.py](examples/gtsrb/run_gtsrb.py)

### 3. Invoking from DeepSaucer
---
1. **Tutorial using MNIST**

    * When using `mnist_cnn.h5`, set `channels_first` in the `image_data_format` of `keras.json`

    Execute from DeepSaucer assuming the following directory structure
    ```text
    Any Directory
    |-- deep_saucer_core
    |   `-- mnist
    |       |-- data
    |       |   |-- dataset_neuron_coverage_keras.py
    |       |   |-- dataset.py
    |       |   |-- dataset_test.py
    |       |   `-- dataset_test_images.py
    |       `-- model
    |           `-- model_neuron_coverage_keras.py
    `-- neuron_coverage
        `-- keras
            |-- examples
            |   `-- mnist
            |       |-- run_mnist.py
            |       `-- model
            |           `--- mnist_cnn.h5
            `-- lib
                |-- coverage_verification.py
                `-- neuron_coverage_keras.sh
    ```

    1. Start `DeepSaucer`
    1. Select `File` - `Env Setup Script`
        1. Select [neuron_coverage_keras.sh](lib/neuron_coverage_keras.sh)
    1. Select `File` - `Dataset Load Script`
       1. Select `deep_saucer_core/mnist/data/dataset_neuron_coverage_keras.py`
       1. Select the `Env Setup Script` selected above
    1. Select `File` - `Model Load Script`
       1. Select `deep_saucer_core/mnist/model/model_neuron_coverage_keras.py`
       1. Select the `Env Setup Script` selected above
    1. Select `File` - `Verification Script`
       1. Select [lib/coverage_verification.py](lib/coverage_verification.py)
       1. Select the `Env Setup Script` selected above
    1. Select the 3 scripts (`Dataset Load`, `Model Load`, and `Verification`) selected above on DeepSaucer
       1. Select `Run` - `Run Test Function`
       1. Select `Next`
       1. Press `Select`, and select [lib/config/config.json](lib/config/config.json)
       1. Verification starts with `Run`

 1. **Tutorial Using GTSRB**

       Execute from DeepSaucer assuming the following directory structure
       ```text
       Any Directory
       |-- deep_saucer_core
       |   |-- downloaded_data
       |   |   |-- test_dataset_3_32_32.h5
       |   |   `-- gtrsb_image_classification_model.hdf5
       |   `-- gtsrb
       |       |-- data
       |       |   `-- dataset_neuron_coverage_keras.py
       |       `-- model
       |           `-- model_neuron_coverage_keras.py
       `-- neuron_coverage
           `-- keras
               |-- examples
               |   `-- gtsrb
               |       `-- run_gtsrb.py
               `-- lib
                   |-- coverage_verification.py
                   `-- neuron_coverage_keras.sh
       ```
       **※ Place the test data created by the common operation in `deep_saucer_core/downloaded_data`**

       1. Start `DeepSaucer`
       1. Select `File` - `Env Setup Script`
           1. Select [neuron_coverage_keras.sh](lib/neuron_coverage_keras.sh)
       1. Select `File` - `Dataset Load Script`
          1. Select `deep_saucer_core/gtsrb/data/dataset_neuron_coverage_keras.py`
          1. Select the `Env Setup Script` selected above
       1. Select `File` - `Model Load Script`
          1. Select `deep_saucer_core/gtsrb/model/model_neuron_coverage_keras.py`
          1. Select the `Env Setup Script` selected above
       1. Select `File` - `Verification Script`
          1. Select [lib/coverage_verification.py](lib/coverage_verification.py)
          1. Select the `Env Setup Script` selected above
       1. Select the 3 scripts (`Dataset Load`, `Model Load`, and `Verification`) selected above on DeepSaucer
          1. Select `Run` - `Run Test Function`
          1. Select `Next`
          1. Press `Select`, and select [lib/config/config.json](lib/config/config.json)
          1. Verification starts with `Run`

### 4. Output
---
Display coverage of the model as a whole, and coverage of each layer in the model, in the standard output. Also, output the heat map of the coverage as an HTML file.
```text
Coverage rate all layer: 0.981613
Coverage rate one layer conv2d_1: 0.961357
Coverage rate one layer conv2d_2: 0.991156
...
```
